<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ä½ç†ç”Ÿæ´» Â· è®°è´¦åŠ©æ‰‹</title>
	<!-- æ ·å¼ï¼šTailwindCSS -->
	<script src="https://cdn.tailwindcss.com"></script>
	<!-- é€»è¾‘ï¼šAlpine.js -->
	<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<!-- è¯†åˆ«ï¼šTesseract.js -->
	<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
	<!-- å›¾è¡¨ï¼šChart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<style>
		[x-cloak] { display: none !important; }
		/* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
		::-webkit-scrollbar { width: 6px; height: 6px; }
		::-webkit-scrollbar-track { background: #f1f1f1; }
		::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
		::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
	</style>
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans text-gray-700" x-data="expenseApp()" x-cloak>

	<!-- é¡¶éƒ¨å¯¼èˆª -->
	<nav class="max-w-7xl mx-auto mb-6 flex items-center justify-between">
		<div class="flex items-center gap-2 text-blue-700">
			<div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
				<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
			</div>
			<div>
				<h1 class="text-2xl font-bold tracking-tight">ä½ç†ç”Ÿæ´» Â· è®°è´¦åŠ©æ‰‹</h1>
				<p class="text-xs text-gray-500">æ•°æ®å­˜å‚¨äºæœ¬åœ°æµè§ˆå™¨ï¼Œæ— é¡»æ‹…å¿ƒéšç§æ³„éœ²ã€‚å»ºè®®ä¸å®šæ—¶å¯¼å‡ºä¿å­˜æ•°æ®ã€‚</p>
			</div>
		</div>
	</nav>

	<!-- ä¸»å¸ƒå±€ï¼šå·¦å³åˆ†æ  -->
	<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

		<!-- å·¦ä¾§ï¼šåŸæœ‰åŠŸèƒ½ (å  4/12) -->
		<div class="lg:col-span-4 space-y-6">
			<div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
				<!-- ä¸Šä¼ åŒºåŸŸå¤´éƒ¨ -->
				<div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
						<h2 class="font-bold text-gray-800">è®°è´¦é¢æ¿</h2>
						<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full" x-text="records.length + ' æ¡è®°å½•'"></span>
				</div>

				<div class="p-6">
					 <!-- ä¸Šä¼ æ§ä»¶ -->
					 <div class="mb-6">
						<label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer bg-gray-50 hover:bg-blue-50 hover:border-blue-300 transition-all relative overflow-hidden group">
							<div class="flex flex-col items-center justify-center pt-5 pb-6" x-show="!isProcessing">
								<svg class="w-8 h-8 text-gray-400 group-hover:text-blue-500 transition-colors mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
								<p class="text-sm text-gray-500">ç‚¹å‡»ä¸Šä¼ é•¿æˆªå›¾</p>
							</div>

							<div class="absolute inset-0 bg-white flex flex-col items-center justify-center z-10" x-show="isProcessing">
								 <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mb-2"></div>
								 <p class="text-xs text-gray-500" x-text="statusText"></p>
								 <div class="w-48 bg-gray-200 rounded-full h-1 mt-2">
										<div class="bg-blue-600 h-1 rounded-full transition-all duration-300" :style="'width: ' + (progress * 100) + '%'"></div>
								 </div>
							</div>
							<input type="file" multiple accept="image/*" @change="handleFileUpload" class="hidden" :disabled="isProcessing" />
						</label>
					</div>

					<!-- æŒ‰é’®ç»„ -->
					<div class="grid grid-cols-3 gap-2 mb-4">
						<!-- å¯¼å‡ºæŒ‰é’® (å¸¦ä¸‹æ‹‰) -->
						<div class="col-span-1 relative" x-data="{ open: false }" @click.outside="open = false">
							<button @click="open = !open" class="w-full h-full bg-gray-50 hover:bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-medium border border-gray-200 flex flex-col items-center justify-center">
									<svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
									å¯¼å‡º
							</button>
							<!-- ä¸‹æ‹‰èœå• -->
							<div x-show="open" x-transition class="absolute bottom-full left-0 w-full mb-1 bg-white border border-gray-200 rounded-lg shadow-lg z-20 overflow-hidden flex flex-col">
								<button @click="exportJson(); open = false" class="py-2 text-xs hover:bg-blue-50 text-gray-700 border-b border-gray-100">JSON å¤‡ä»½</button>
								<button @click="exportCsv(); open = false" class="py-2 text-xs hover:bg-blue-50 text-gray-700">CSV è¡¨æ ¼</button>
							</div>
						</div>

						<!-- å¯¼å…¥æŒ‰é’® -->
						<button @click="$refs.importInput.click()" class="col-span-1 bg-gray-50 hover:bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-medium border border-gray-200 flex flex-col items-center justify-center">
								<svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
								å¯¼å…¥
						</button>
						
						<!-- æ¸…ç©ºæŒ‰é’® -->
						<button @click="clearData" class="col-span-1 bg-red-50 hover:bg-red-100 text-red-500 py-2 rounded-lg text-xs font-medium border border-red-100 flex flex-col items-center justify-center">
							 <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
							 æ¸…ç©º
						</button>
						
						<!-- éšè—çš„ Inputï¼Œå¢åŠ äº† .csv æ”¯æŒ -->
						<input type="file" x-ref="importInput" @change="handleImport" accept=".json,.csv" class="hidden" />
					</div>

					<!-- æ»šåŠ¨åˆ—è¡¨ -->
					<div class="overflow-hidden rounded-xl border border-gray-100">
						<ul class="divide-y divide-gray-100 bg-white h-[500px] overflow-y-auto">
							<template x-for="item in sortedRecords" :key="item.time">
								<li class="p-3 hover:bg-gray-50 transition-colors flex justify-between items-center text-sm">
									<div class="flex items-center gap-3">
										<div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0"
												 :class="getTypeColor(item.type)">
												 <span class="text-xs font-bold" x-text="item.type[0]"></span>
										</div>
										<div>
											<div class="font-medium text-gray-900" x-text="item.type"></div>
											<div class="text-[10px] text-gray-400" x-text="item.time"></div>
										</div>
									</div>
									<div class="font-bold text-gray-800" x-text="'-' + item.amount.toFixed(2)"></div>
								</li>
							</template>
							<li x-show="records.length === 0" class="p-10 text-center text-gray-400 text-sm flex flex-col items-center">
								<svg class="w-10 h-10 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
								æš‚æ— æ•°æ®
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<!-- å³ä¾§ï¼šç»Ÿè®¡é¢æ¿ (å  8/12) -->
		<div class="lg:col-span-8 space-y-6" x-show="records.length > 0" x-transition>

			<!-- 1. æ¦‚è§ˆå¡ç‰‡ (æ”¯ä»˜å®é£æ ¼) -->
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<!-- æ€»æ”¯å‡º -->
				<div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-200">
						<div class="text-blue-100 text-xs uppercase tracking-wider font-semibold mb-1">æ€»æ¶ˆè´¹æ”¯å‡º</div>
						<div class="text-3xl font-bold flex items-baseline">
								<span class="text-lg mr-1">Â¥</span>
								<span x-text="totalAmount.toFixed(2)"></span>
						</div>
						<div class="mt-4 text-xs text-blue-100 bg-white/20 inline-block px-2 py-1 rounded">
								å…± <span x-text="records.length"></span> ç¬”äº¤æ˜“
						</div>
				</div>

				<!-- æœˆå‡æ¶ˆè´¹ -->
				<div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between">
						<div>
								<div class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">æœˆå‡æ¶ˆè´¹ (ä¼°ç®—)</div>
								<div class="text-2xl font-bold text-gray-800 flex items-baseline">
										<span class="text-sm mr-1">Â¥</span>
										<span x-text="monthlyAverage"></span>
								</div>
						</div>
						<div class="mt-2 text-xs text-gray-400">
								åŸºäº <span x-text="uniqueMonths.length"></span> ä¸ªæœ‰è®°å½•çš„æœˆä»½<br>
								<span class="text-[10px] text-gray-300">* æœ€æ–°æœˆä»½æ•°æ®å¯èƒ½ä¸å…¨</span>
						</div>
				</div>

				<!-- æœ€é«˜é¢‘æ¶ˆè´¹ -->
				<div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between">
						<div>
								<div class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">æœ€å¸¸æ¶ˆè´¹ç±»å‹</div>
								<div class="text-2xl font-bold text-gray-800" x-text="topCategory.name"></div>
						</div>
						<div class="flex items-center gap-2 mt-2">
								 <div class="h-2 flex-1 bg-gray-100 rounded-full overflow-hidden">
										<div class="h-full bg-yellow-400" :style="'width: ' + topCategory.percent + '%'"></div>
								 </div>
								 <span class="text-xs text-gray-500" x-text="topCategory.percent + '%'"></span>
						</div>
				</div>
			</div>

			<!-- 2. æœˆåº¦è¶‹åŠ¿å›¾ -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
					<div class="flex justify-between items-center mb-6">
							<h3 class="font-bold text-gray-800 text-lg">ğŸ“… æœˆåº¦è´¦å•ç»Ÿè®¡</h3>
							<div class="text-xs text-gray-400">æŸ±çŠ¶å›¾å±•ç¤ºæ¯æœˆæ€»èŠ±é”€</div>
					</div>
					<div class="h-64 w-full">
							<canvas id="monthlyChart"></canvas>
					</div>
			</div>

			<!-- 3. æ¶ˆè´¹ä¹ æƒ¯çƒ­åŠ› (æ—¶é—´æ®µå †å å›¾) -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
					<div class="flex justify-between items-center mb-6">
							<h3 class="font-bold text-gray-800 text-lg">ğŸ•’ æ¶ˆè´¹æ—¶æ®µä¹ æƒ¯</h3>
							<div class="text-xs text-gray-400">ä¸åŒæ—¶é—´æ®µçš„æ¶ˆè´¹é¢‘ç‡åˆ†å¸ƒ</div>
					</div>
					<div class="h-80 w-full">
							<canvas id="hourlyChart"></canvas>
					</div>
					<p class="text-xs text-gray-400 mt-4 text-center">
							æ¨ªè½´ï¼š24å°æ—¶åˆ¶æ—¶é—´ç‚¹ Â· çºµè½´ï¼šæ¶ˆè´¹æ¬¡æ•° Â· é¢œè‰²ï¼šæ¶ˆè´¹ç±»å‹
					</p>
			</div>

		</div>

		<!-- å ä½ç¬¦ï¼šå½“æ²¡æœ‰æ•°æ®æ—¶å³ä¾§æ˜¾ç¤ºçš„å¼•å¯¼ -->
		<div class="lg:col-span-8 flex flex-col items-center justify-center bg-white rounded-2xl border border-dashed border-gray-200 p-10 text-center" x-show="records.length === 0">
				<div class="bg-blue-50 p-4 rounded-full mb-4">
						<svg class="w-12 h-12 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z"></path></svg>
				</div>
				<h3 class="text-xl font-bold text-gray-700 mb-2">æ•°æ®ç»Ÿè®¡é¢æ¿</h3>
				<p class="text-gray-400 max-w-sm">è¯·åœ¨å·¦ä¾§ä¸Šä¼ æˆªå›¾æˆ–å¯¼å…¥æ•°æ®ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆæœˆåº¦è¶‹åŠ¿å›¾å’Œæ¶ˆè´¹ä¹ æƒ¯åˆ†æã€‚</p>
		</div>

	</div>

	<script>
		document.addEventListener('alpine:init', () => {
			Alpine.data('expenseApp', () => ({
				records: [],
				isProcessing: false,
				progress: 0,
				statusText: 'å‡†å¤‡å°±ç»ª',

				// å›¾è¡¨å®ä¾‹å¼•ç”¨
				charts: {
						monthly: null,
						hourly: null
				},

				init() {
					const stored = localStorage.getItem('my_expense_data');
					if (stored) {
						try { this.records = JSON.parse(stored); } catch(e) {}
					}
					// ç›‘å¬æ•°æ®å˜åŒ–æ›´æ–°å›¾è¡¨
					this.$watch('records', () => {
						 this.$nextTick(() => this.updateCharts());
					});
					// é¦–æ¬¡åŠ è½½å¦‚æœæœ‰æ•°æ®ä¹Ÿæ¸²æŸ“
					if(this.records.length > 0) {
						 this.$nextTick(() => this.updateCharts());
					}
				},

				// --- è®¡ç®—å±æ€§ ---
				get sortedRecords() {
					return [...this.records].sort((a, b) => new Date(b.time) - new Date(a.time));
				},

				get totalAmount() {
					return this.records.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
				},

				get uniqueMonths() {
						const months = new Set(this.records.map(r => r.time.substring(0, 7))); // YYYY-MM
						return Array.from(months).sort();
				},

				get monthlyAverage() {
						if (this.uniqueMonths.length === 0) return '0.00';
						// ç®€å•å¹³å‡ï¼šæ€»é‡‘é¢ / æœˆä»½æ•°é‡
						// æ³¨æ„ï¼šè™½ç„¶ç”¨æˆ·è¯´æœ€æ–°æœˆä»½ä¸å®Œæ•´ï¼Œä½†ä¸ºäº†æ•°å­¦é€»è¾‘é—­ç¯ï¼Œç›´æ¥å¹³å‡æ˜¯æ¯”è¾ƒé€šç”¨çš„å±•ç¤º
						return (this.totalAmount / this.uniqueMonths.length).toFixed(2);
				},

				get topCategory() {
						if (this.records.length === 0) return { name: 'æ— ', percent: 0 };
						const counts = {};
						this.records.forEach(r => { counts[r.type] = (counts[r.type] || 0) + 1; });
						const top = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
						const percent = Math.round((counts[top] / this.records.length) * 100);
						return { name: top, percent: percent };
				},

				// --- æ ·å¼å·¥å…· ---
				getTypeColor(type) {
						const map = {
								'é¥®æ°´': 'bg-blue-100 text-blue-600',
								'æ´—æµ´': 'bg-purple-100 text-purple-600',
								'å¹é£': 'bg-yellow-100 text-yellow-600',
								'æ´—è¡£': 'bg-green-100 text-green-600',
						};
						return map[type] || 'bg-gray-100 text-gray-600';
				},

				// --- æ ¸å¿ƒä¸šåŠ¡ï¼šOCR ---
				async handleFileUpload(e) {
					const files = e.target.files;
					if (!files.length) return;
					this.isProcessing = true;
					try {
						this.statusText = 'åŠ è½½æ–‡å­—è¯†åˆ«æ¨¡å‹...';
						const worker = await Tesseract.createWorker('chi_sim+eng', 1, {
							logger: m => { if(m.status === 'recognizing text') this.progress = m.progress; },
							langPath: 'https://cdn.jsdelivr.net/gh/naptha/tessdata@gh-pages/4.0.0_best/',
              corePath: 'https://cdn.jsdelivr.net/npm/tesseract.js-core@5.0.0/tesseract-core.wasm.js',
              workerPath: 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js'
            });
						for (let i = 0; i < files.length; i++) {
							this.statusText = `è¯†åˆ« ${i + 1}/${files.length}...`;
							this.progress = 0;
							const ret = await worker.recognize(files[i]);
							this.parseAndMerge(ret.data.text);
						}
						await worker.terminate();
						this.saveToStorage();
					} catch (err) {
						console.error(err);
						alert('è¯†åˆ«å‡ºé”™');
					} finally {
						this.isProcessing = false;
						e.target.value = '';
					}
				},

				parseAndMerge(text) {
					const lines = text.split(/\n+/).map(l => l.trim()).filter(l => l);
					const timeRegex = /(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/;
					const amountRegex = /-(\d+\.\d+)/;
					const typeRegex = /(é¥®æ°´|æ´—æµ´|å¹é£|æ´—è¡£|æ¶ˆè´¹|è´­ç‰©)/;

					for (let i = 0; i < lines.length; i++) {
						const line = lines[i];
						const timeMatch = line.match(timeRegex);
						if (timeMatch) {
							const timeStr = timeMatch[1];
							let contextLines = [line];
							if (i > 0) contextLines.push(lines[i-1]);
							if (i > 1) contextLines.push(lines[i-2]);
							const contextStr = contextLines.join(' ');
							const amountMatch = contextStr.match(amountRegex);
							const typeMatch = contextStr.match(typeRegex);
							if (amountMatch) {
								 this.addRecordIfNew({
									 time: timeStr,
									 type: typeMatch ? typeMatch[1] : 'å…¶ä»–',
									 amount: parseFloat(amountMatch[1])
								 });
							}
						}
					}
				},

				addRecordIfNew(item) {
					const exists = this.records.some(r => r.time === item.time);
					if (!exists) { this.records.push(item); return true; }
					return false;
				},

				saveToStorage() {
					localStorage.setItem('my_expense_data', JSON.stringify(this.records));
				},

				clearData() {
					if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
						this.records = [];
						localStorage.removeItem('my_expense_data');
						// é”€æ¯å›¾è¡¨
						if (this.charts.monthly) this.charts.monthly.destroy();
						if (this.charts.hourly) this.charts.hourly.destroy();
					}
				},

				// --- å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ (ä¿®æ”¹å) ---
				
				// è¾…åŠ©ï¼šä¸‹è½½æ–‡ä»¶
				downloadFile(content, fileName, mimeType) {
						const blob = new Blob([content], { type: mimeType });
						const url = URL.createObjectURL(blob);
						const a = document.createElement('a');
						a.href = url;
						a.download = fileName;
						document.body.appendChild(a); a.click(); document.body.removeChild(a);
				},

				// å¯¼å‡º JSON
				exportJson() {
						if (this.records.length === 0) { alert('æ²¡æœ‰æ•°æ®'); return; }
						const grouped = {};
						const sorted = [...this.records].sort((a, b) => new Date(b.time) - new Date(a.time));
						sorted.forEach(item => {
								const monthKey = item.time.substring(0, 7);
								if (!grouped[monthKey]) grouped[monthKey] = [];
								grouped[monthKey].push(item);
						});
						this.downloadFile(JSON.stringify(grouped, null, 2), `expense_backup_${new Date().toISOString().split('T')[0]}.json`, "application/json");
				},

				// å¯¼å‡º CSV
				exportCsv() {
						if (this.records.length === 0) { alert('æ²¡æœ‰æ•°æ®'); return; }
						const sorted = [...this.records].sort((a, b) => new Date(b.time) - new Date(a.time));
						// CSV å¤´éƒ¨
						let csvContent = "Time,Type,Amount\n";
						// CSV å†…å®¹
						sorted.forEach(item => {
								csvContent += `${item.time},${item.type},${item.amount}\n`;
						});
						// æ·»åŠ  BOM (\uFEFF) ä»¥è§£å†³ Excel æ‰“å¼€ä¸­æ–‡ä¹±ç é—®é¢˜
						this.downloadFile("\uFEFF" + csvContent, `expense_export_${new Date().toISOString().split('T')[0]}.csv`, "text/csv;charset=utf-8;");
				},

				// ç»Ÿä¸€å¤„ç†å¯¼å…¥
				handleImport(e) {
						const file = e.target.files[0];
						if (!file) return;
						const reader = new FileReader();
						reader.onload = (event) => {
								const content = event.target.result;
								let added = 0;
								
								try {
										// å°è¯•ä½œä¸º JSON è§£æ
										if (file.name.toLowerCase().endsWith('.json')) {
												const importedData = JSON.parse(content);
												let newItems = [];
												if (Array.isArray(importedData)) {
														newItems = importedData;
												} else {
														Object.values(importedData).forEach(monthList => {
																if (Array.isArray(monthList)) newItems = newItems.concat(monthList);
														});
												}
												newItems.forEach(item => {
														if (item.time && item.amount && this.addRecordIfNew(item)) added++;
												});
										} 
										// å°è¯•ä½œä¸º CSV è§£æ
										else if (file.name.toLowerCase().endsWith('.csv')) {
												const lines = content.split(/\r\n|\n/);
												// è·³è¿‡ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼ˆå¦‚æœå­˜åœ¨ Time,Type,Amountï¼‰
												lines.forEach((line, index) => {
														const parts = line.split(',');
														if (parts.length >= 3) {
																const time = parts[0].trim();
																const type = parts[1].trim();
																const amount = parseFloat(parts[2].trim());
																// ç®€å•çš„æ ¼å¼æ ¡éªŒ
																if (time.match(/^\d{4}-\d{2}-\d{2}/) && !isNaN(amount)) {
																		if (this.addRecordIfNew({ time, type, amount })) added++;
																}
														}
												});
										} else {
												alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼");
												return;
										}

										this.saveToStorage();
										alert(`å¯¼å…¥æˆåŠŸï¼šæ–°å¢ ${added} æ¡`);
								} catch (err) {
										console.error(err);
										alert('æ–‡ä»¶è§£æé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
								} finally {
										e.target.value = '';
								}
						};
						reader.readAsText(file);
				},

				// --- å›¾è¡¨æ¸²æŸ“é€»è¾‘ ---
				updateCharts() {
						if (this.records.length === 0) return;

						this.renderMonthlyChart();
						this.renderHourlyChart();
				},

				renderMonthlyChart() {
						const ctx = document.getElementById('monthlyChart');
						if (!ctx) return;

						// 1. æ•°æ®å‡†å¤‡
						const monthMap = {};
						this.uniqueMonths.forEach(m => monthMap[m] = 0);
						this.records.forEach(r => {
								const m = r.time.substring(0, 7);
								monthMap[m] += r.amount;
						});

						const labels = Object.keys(monthMap);
						const data = Object.values(monthMap);

						// 2. é”€æ¯æ—§å›¾è¡¨
						if (this.charts.monthly) this.charts.monthly.destroy();

						// 3. åˆ›å»ºæ–°å›¾è¡¨
						this.charts.monthly = new Chart(ctx, {
								type: 'bar',
								data: {
										labels: labels,
										datasets: [{
												label: 'æœˆåº¦æ€»æ”¯å‡º (å…ƒ)',
												data: data,
												backgroundColor: 'rgba(59, 130, 246, 0.6)', // Blue-500
												borderColor: 'rgb(59, 130, 246)',
												borderWidth: 1,
												borderRadius: 6
										}]
								},
								options: {
										responsive: true,
										maintainAspectRatio: false,
										plugins: {
												legend: { display: false }
										},
										scales: {
												y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
												x: { grid: { display: false } }
										}
								}
						});
				},

				renderHourlyChart() {
						const ctx = document.getElementById('hourlyChart');
						if (!ctx) return;

						// 1. æ•°æ®å‡†å¤‡ (æŒ‰å°æ—¶ 0-23 åˆ†æ¡¶ï¼Œç»Ÿè®¡å„ç±»å‹çš„æ¬¡æ•°)
						const hours = Array.from({length: 24}, (_, i) => i); // [0, 1, ... 23]
						const categories = ['é¥®æ°´', 'æ´—æµ´', 'å¹é£', 'å…¶ä»–'];

						// åˆå§‹åŒ–æ•°æ®é›†ç»“æ„
						const datasetsData = {};
						categories.forEach(c => datasetsData[c] = new Array(24).fill(0));

						this.records.forEach(r => {
								const hour = new Date(r.time).getHours();
								// å½’ç±»
								let type = r.type;
								if (!datasetsData[type]) type = 'å…¶ä»–';
								datasetsData[type][hour] += 1; // ç»Ÿè®¡æ¬¡æ•° (Frequency)
						});

						// é¢œè‰²æ˜ å°„
						const colors = {
								'é¥®æ°´': 'rgba(59, 130, 246, 0.8)', // Blue
								'æ´—æµ´': 'rgba(147, 51, 234, 0.8)', // Purple
								'å¹é£': 'rgba(234, 179, 8, 0.8)',  // Yellow
								'å…¶ä»–': 'rgba(156, 163, 175, 0.5)' // Gray
						};

						const datasets = categories.map(c => ({
								label: c,
								data: datasetsData[c],
								backgroundColor: colors[c],
								stack: 'Stack 0',
						}));

						// 2. é”€æ¯æ—§å›¾è¡¨
						if (this.charts.hourly) this.charts.hourly.destroy();

						// 3. åˆ›å»ºæ–°å›¾è¡¨
						this.charts.hourly = new Chart(ctx, {
								type: 'bar',
								data: {
										labels: hours.map(h => `${h}ç‚¹`),
										datasets: datasets
								},
								options: {
										responsive: true,
										maintainAspectRatio: false,
										interaction: {
												mode: 'index',
												intersect: false,
										},
										plugins: {
												tooltip: {
														callbacks: {
																footer: (items) => {
																		const total = items.reduce((a, b) => a + b.parsed.y, 0);
																		return `è¯¥æ—¶æ®µæ€»è®¡: ${total} æ¬¡`;
																}
														}
												}
										},
										scales: {
												x: { stacked: true, grid: { display: false } },
												y: { stacked: true, beginAtZero: true }
										}
								}
						});
				}

			}))
		})
	</script>
</body>
</html>
