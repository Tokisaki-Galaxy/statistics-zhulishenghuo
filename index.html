<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>住理生活 · 记账助手</title>
	<!-- 样式：TailwindCSS -->
	<script src="https://cdn.tailwindcss.com"></script>
	<!-- 逻辑：Alpine.js -->
	<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<!-- 识别：Tesseract.js -->
	<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
	<!-- 图表：Chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<link rel="stylesheet" href="src/styles.css">
</head>
<body class="bg-gray-100 min-h-screen p-4 font-sans text-gray-700" x-data="expenseApp()" x-cloak>

	<!-- 顶部导航 -->
	<nav class="max-w-7xl mx-auto mb-6 flex items-center justify-between">
		<div class="flex items-center gap-2 text-blue-700">
			<div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
				<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
			</div>
			<div>
				<h1 class="text-2xl font-bold tracking-tight">住理生活 · 记账助手</h1>
				<p class="text-xs text-gray-500">数据全程在本地浏览器，无须担心隐私泄露。建议不定时导出保存数据。</p>
			</div>
		</div>
		<!-- GitHub 链接按钮 -->
		<a href="https://github.com/Tokisaki-Galaxy/statistics-zhulishenghuo" target="_blank" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium shadow-sm">
			<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.43.372.823 1.102.823 2.222 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
			<span>GitHub与使用教程</span>
		</a>
	</nav>

	<!-- 主布局：左右分栏 -->
	<div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

		<!-- 左侧：原有功能 (占 4/12) -->
		<div class="lg:col-span-4 space-y-6">
			<div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
				<!-- 上传区域头部 -->
				<div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
						<h2 class="font-bold text-gray-800">记账面板</h2>
						<span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full" x-text="records.length + ' 条记录'"></span>
				</div>

				<div class="p-6">
					 <!-- 上传控件 -->
					 <div class="mb-6">
						<label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer bg-gray-50 hover:bg-blue-50 hover:border-blue-300 transition-all relative overflow-hidden group">
							<div class="flex flex-col items-center justify-center pt-5 pb-6" x-show="!isProcessing">
								<svg class="w-8 h-8 text-gray-400 group-hover:text-blue-500 transition-colors mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
								<p class="text-sm text-gray-500">点击上传长截图</p>
							</div>

							<div class="absolute inset-0 bg-white flex flex-col items-center justify-center z-10" x-show="isProcessing">
								 <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mb-2"></div>
								 <p class="text-xs text-gray-500" x-text="statusText"></p>
								 <div class="w-48 bg-gray-200 rounded-full h-1 mt-2">
										<div class="bg-blue-600 h-1 rounded-full transition-all duration-300" :style="'width: ' + (progress * 100) + '%'"></div>
								 </div>
							</div>
							<input type="file" multiple accept="image/*" @change="handleFileUpload" class="hidden" :disabled="isProcessing" />
						</label>
					</div>

					<!-- 按钮组 -->
					<div class="grid grid-cols-3 gap-2 mb-4">
						<!-- 导出按钮 (带下拉) -->
						<div class="col-span-1 relative" x-data="{ open: false }" @click.outside="open = false">
							<button @click="open = !open" class="w-full h-full bg-gray-50 hover:bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-medium border border-gray-200 flex flex-col items-center justify-center">
									<svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
									导出
							</button>
							<!-- 下拉菜单 -->
							<div x-show="open" x-transition class="absolute bottom-full left-0 w-full mb-1 bg-white border border-gray-200 rounded-lg shadow-lg z-20 overflow-hidden flex flex-col">
								<button @click="exportJson(); open = false" class="py-2 text-xs hover:bg-blue-50 text-gray-700 border-b border-gray-100">JSON 备份</button>
								<button @click="exportCsv(); open = false" class="py-2 text-xs hover:bg-blue-50 text-gray-700">CSV 表格</button>
							</div>
						</div>

						<!-- 导入按钮 -->
						<button @click="$refs.importInput.click()" class="col-span-1 bg-gray-50 hover:bg-gray-100 text-gray-600 py-2 rounded-lg text-xs font-medium border border-gray-200 flex flex-col items-center justify-center">
								<svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
								导入
						</button>
						
						<!-- 清空按钮 -->
						<button @click="clearData" class="col-span-1 bg-red-50 hover:bg-red-100 text-red-500 py-2 rounded-lg text-xs font-medium border border-red-100 flex flex-col items-center justify-center">
							 <svg class="w-4 h-4 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
							 清空
						</button>
						
						<!-- 隐藏的 Input，增加了 .csv 支持 -->
						<input type="file" x-ref="importInput" @change="handleImport" accept=".json,.csv" class="hidden" />
					</div>

					<!-- 滚动列表 -->
					<div class="overflow-hidden rounded-xl border border-gray-100">
						<ul class="divide-y divide-gray-100 bg-white h-[500px] overflow-y-auto">
							<template x-for="item in limitedRecords" :key="item.time">
								<li class="p-3 hover:bg-gray-50 transition-colors flex justify-between items-center text-sm">
									<div class="flex items-center gap-3">
										<div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0"
												 :class="getTypeColor(item.type)">
												 <span class="text-xs font-bold" x-text="item.type[0]"></span>
										</div>
										<div>
											<div class="font-medium text-gray-900" x-text="item.type"></div>
											<div class="text-[10px] text-gray-400" x-text="item.time"></div>
										</div>
									</div>
									<div class="font-bold text-gray-800" x-text="'-' + item.amount.toFixed(2)"></div>
								</li>
							</template>
							<!-- 加载更多 -->
							<li x-show="records.length > displayLimit" class="p-2">
								<button @click="displayLimit += 100" class="w-full py-2 text-xs text-blue-600 hover:bg-blue-50 rounded-lg transition-colors font-medium">
									加载更多 (还有 <span x-text="records.length - displayLimit"></span> 条)
								</button>
							</li>
							<li x-show="records.length === 0" class="p-10 text-center text-gray-400 text-sm flex flex-col items-center">
								<svg class="w-10 h-10 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
								暂无数据
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>

		<!-- 右侧：统计面板 (占 8/12) -->
		<div class="lg:col-span-8 space-y-6" x-show="records.length > 0" x-transition>

			<!-- 1. 概览卡片 (支付宝风格) -->
			<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
				<!-- 总支出 -->
				<div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-200">
						<div class="text-blue-100 text-xs uppercase tracking-wider font-semibold mb-1">总消费支出</div>
						<div class="text-3xl font-bold flex items-baseline">
								<span class="text-lg mr-1">¥</span>
								<span x-text="totalAmount.toFixed(2)"></span>
						</div>
						<div class="mt-4 text-xs text-blue-100 bg-white/20 inline-block px-2 py-1 rounded">
								共 <span x-text="records.length"></span> 笔交易
						</div>
				</div>

				<!-- 月均消费 -->
				<div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between">
						<div>
								<div class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">月均消费 (估算)</div>
								<div class="text-2xl font-bold text-gray-800 flex items-baseline">
										<span class="text-sm mr-1">¥</span>
										<span x-text="monthlyAverage"></span>
								</div>
						</div>
						<div class="mt-2 text-xs text-gray-400">
								基于 <span x-text="uniqueMonths.length"></span> 个有记录的月份<br>
								<span class="text-[10px] text-gray-300">* 最新月份数据可能不全</span>
						</div>
				</div>

				<!-- 最高频消费 -->
				<div class="bg-white rounded-2xl p-5 border border-gray-100 shadow-sm flex flex-col justify-between">
						<div>
								<div class="text-gray-400 text-xs uppercase tracking-wider font-semibold mb-1">最常消费类型</div>
								<div class="text-2xl font-bold text-gray-800" x-text="topCategory.name"></div>
						</div>
						<div class="flex items-center gap-2 mt-2">
								 <div class="h-2 flex-1 bg-gray-100 rounded-full overflow-hidden">
										<div class="h-full bg-yellow-400" :style="'width: ' + topCategory.percent + '%'"></div>
								 </div>
								 <span class="text-xs text-gray-500" x-text="topCategory.percent + '%'"></span>
						</div>
				</div>
			</div>

			<!-- 2. 月度趋势图 -->
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
						<div class="flex justify-between items-center mb-6">
								<h3 class="font-bold text-gray-800 text-lg">📅 月度账单统计</h3>
								<div class="text-xs text-gray-400">每月总花销</div>
						</div>
						<div class="h-64 w-full">
								<canvas id="monthlyChart"></canvas>
						</div>
				</div>

				<!-- 2.5 消费分类占比 -->
				<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
						<div class="flex justify-between items-center mb-6">
								<h3 class="font-bold text-gray-800 text-lg">🍕 消费分类占比</h3>
								<div class="text-xs text-gray-400">各类型支出比例</div>
						</div>
						<div class="h-64 w-full">
								<canvas id="categoryChart"></canvas>
						</div>
				</div>
			</div>

			<!-- 3. 消费习惯热力 (时间段堆叠图) -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
					<div class="flex justify-between items-center mb-6">
							<h3 class="font-bold text-gray-800 text-lg">🕒 消费时段习惯</h3>
							<div class="flex items-center bg-gray-100 p-1 rounded-lg">
									<button @click="hourlyMode = 'count'" 
													:class="hourlyMode === 'count' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500'" 
													class="px-3 py-1 rounded-md text-xs font-medium transition-all">次数</button>
									<button @click="hourlyMode = 'amount'" 
													:class="hourlyMode === 'amount' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500'" 
													class="px-3 py-1 rounded-md text-xs font-medium transition-all">金额</button>
									<button @click="hourlyMode = 'average'" 
													:class="hourlyMode === 'average' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500'" 
													class="px-3 py-1 rounded-md text-xs font-medium transition-all">平均金额</button>
							</div>
					</div>
					<div class="h-80 w-full">
							<canvas id="hourlyChart"></canvas>
					</div>
					<p class="text-xs text-gray-400 mt-4 text-center">
							横轴：24小时制时间点 · 纵轴：<span x-text="hourlyMode === 'count' ? '消费次数' : (hourlyMode === 'amount' ? '消费金额' : '平均金额')"></span> · 颜色：消费类型
					</p>
			</div>

			<!-- 4. 消费热力图 (GitHub 风格) -->
			<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
					<div class="flex justify-between items-center mb-4">
							<h3 class="font-bold text-gray-800 text-lg">📊 年度消费热力</h3>
							<div class="flex items-center gap-1 text-[10px] text-gray-400">
									<span>少</span>
									<div class="w-3 h-3 bg-gray-100 rounded-sm"></div>
									<div class="w-3 h-3 bg-green-200 rounded-sm"></div>
									<div class="w-3 h-3 bg-green-400 rounded-sm"></div>
									<div class="w-3 h-3 bg-green-600 rounded-sm"></div>
									<div class="w-3 h-3 bg-green-800 rounded-sm"></div>
									<span>多 (Max: ¥<span x-text="maxDailyAmount.toFixed(0)"></span>)</span>
							</div>
					</div>
					<div class="overflow-x-auto pb-2">
							<div class="flex flex-col flex-wrap h-32 gap-1" style="align-content: flex-start; min-width: 750px;">
									<template x-for="day in heatmapDays" :key="day.date">
											<div :title="day.date + ': ¥' + day.amount.toFixed(2)"
													 class="w-3 h-3 rounded-sm transition-colors cursor-help hover:ring-1 hover:ring-gray-400"
													 :class="getHeatmapColor(day.amount)">
											</div>
									</template>
							</div>
					</div>
					<p class="text-[10px] text-gray-400 mt-2">显示最近一年的消费分布（深色表示当天消费金额更高，鼠标悬浮查看详情）</p>
			</div>
		</div>

		<!-- 占位符：当没有数据时右侧显示的引导 -->
		<div class="lg:col-span-8 flex flex-col items-center justify-center bg-white rounded-2xl border border-dashed border-gray-200 p-10 text-center" x-show="records.length === 0">
				<div class="bg-blue-50 p-4 rounded-full mb-4">
						<svg class="w-12 h-12 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 002 2h2a2 2 0 002-2z"></path></svg>
				</div>
				<h3 class="text-xl font-bold text-gray-700 mb-2">数据统计面板</h3>
				<p class="text-gray-400 max-w-sm">请在左侧上传截图或导入数据，系统将自动生成月度趋势图和消费习惯分析。</p>
		</div>

	</div>

	<script src="src/db.js"></script>
	<script src="src/app.js"></script>
</body>
</html>
